"use strict";

var _interopRequire = function (obj) { return obj && obj.__esModule ? obj["default"] : obj; };

var _prototypeProperties = function (child, staticProps, instanceProps) { if (staticProps) Object.defineProperties(child, staticProps); if (instanceProps) Object.defineProperties(child.prototype, instanceProps); };

var _inherits = function (subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) subClass.__proto__ = superClass; };

var _classCallCheck = function (instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } };

var _Flux = require("../Flux");

var Flux = _Flux.Flux;
var Actions = _Flux.Actions;
var sinon = _interopRequire(require("sinon"));

describe("Actions", function () {
  var TestActions = (function (Actions) {
    function TestActions() {
      _classCallCheck(this, TestActions);

      if (Actions != null) {
        Actions.apply(this, arguments);
      }
    }

    _inherits(TestActions, Actions);

    _prototypeProperties(TestActions, null, {
      getFoo: {
        value: function getFoo() {
          return { foo: "bar" };
        },
        writable: true,
        configurable: true
      },
      getBar: {
        value: function getBar() {
          return { bar: "baz" };
        },
        writable: true,
        configurable: true
      },
      getBaz: {
        value: function getBaz() {
          return;
        },
        writable: true,
        configurable: true
      },
      asyncAction: {
        value: function asyncAction(returnValue) {
          return regeneratorRuntime.async(function asyncAction$(context$3$0) {
            while (1) switch (context$3$0.prev = context$3$0.next) {
              case 0:
                return context$3$0.abrupt("return", returnValue);
              case 1:
              case "end":
                return context$3$0.stop();
            }
          }, null, this);
        },
        writable: true,
        configurable: true
      },
      badAsyncAction: {
        value: function badAsyncAction() {
          return Promise.reject(new Error("some error"));
        },
        writable: true,
        configurable: true
      }
    });

    return TestActions;
  })(Actions);

  describe("#getActionIds / #getConstants", function () {
    it("returns strings corresponding to action method names", function () {
      var actions = new TestActions();

      var actionIds = actions.getActionIds();

      expect(actionIds.getFoo).to.be.a("string");
      expect(actionIds.getBar).to.be.a("string");

      expect(actionIds.getFoo).to.be.a("string");
      expect(actionIds.getBar).to.be.a("string");
    });
  });

  describe("#[methodName]", function () {
    it("calls Flux dispatcher", function () {
      var actions = new TestActions();

      // Attach mock flux instance
      var dispatch = sinon.spy();
      actions.dispatch = dispatch;

      actions.getFoo();
      expect(dispatch.firstCall.args[1]).to.deep.equal({ foo: "bar" });
    });

    it("warns if actions have not been added to a Flux instance", function () {
      var actions = new TestActions();
      var warn = sinon.spy(console, "warn");

      actions.getFoo();

      expect(warn.firstCall.args[0]).to.equal("You've attempted to perform the action TestActions#getFoo, but it " + "hasn't been added to a Flux instance.");

      actions.asyncAction();

      expect(warn.secondCall.args[0]).to.equal("You've attempted to perform the asynchronous action " + "TestActions#asyncAction, but it hasn't been added " + "to a Flux instance.");

      console.warn.restore();
    });

    it("sends return value to Flux dispatch", function () {
      var actions = new TestActions();
      var actionId = actions.getActionIds().getFoo;
      var dispatch = sinon.spy();
      actions.dispatch = dispatch;

      actions.getFoo();

      expect(dispatch.firstCall.args[0]).to.equal(actionId);
      expect(dispatch.firstCall.args[1]).to.deep.equal({ foo: "bar" });
    });

    it("send async return value to Flux#dispatchAsync", function callee$2$0() {
      var actions, actionId, dispatch, response;
      return regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            actions = new TestActions();
            actionId = actions.getActionIds().asyncAction;
            dispatch = sinon.stub().returns(Promise.resolve());
            actions.dispatchAsync = dispatch;

            response = actions.asyncAction("foobar");


            expect(response.then).to.be.a("function");

            context$3$0.next = 8;
            return response;
          case 8:


            expect(dispatch.firstCall.args[0]).to.equal(actionId);
            expect(dispatch.firstCall.args[1]).to.be.an.instanceOf(Promise);
          case 10:
          case "end":
            return context$3$0.stop();
        }
      }, null, this);
    });

    it("skips disptach if return value is undefined", function () {
      var actions = new TestActions();
      var dispatch = sinon.spy();
      actions.dispatch = dispatch;

      actions.getBaz();

      expect(dispatch.called).to.be["false"];
    });

    it("does not skip async dispatch, even if resolved value is undefined", function () {
      var actions = new TestActions();
      var dispatch = sinon.stub().returns(Promise.resolve(undefined));
      actions.dispatchAsync = dispatch;

      actions.asyncAction(undefined);

      expect(dispatch.called).to.be["true"];
    });

    it("returns value from wrapped action", function callee$2$1() {
      var flux, actions;
      return regeneratorRuntime.async(function callee$2$1$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            flux = new Flux();
            actions = flux.createActions("test", TestActions);


            expect(actions.getFoo()).to.deep.equal({ foo: "bar" });
            context$3$0.next = 5;
            return expect(actions.asyncAction("async result")).to.eventually.equal("async result");
          case 5:
          case "end":
            return context$3$0.stop();
        }
      }, null, this);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9fX3Rlc3RzX18vQWN0aW9ucy10ZXN0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7b0JBQThCLFNBQVM7O0lBQTlCLElBQUksU0FBSixJQUFJO0lBQUUsT0FBTyxTQUFQLE9BQU87SUFDZixLQUFLLDJCQUFNLE9BQU87O0FBRXpCLFFBQVEsQ0FBQyxTQUFTLEVBQUUsWUFBTTtNQUVsQixXQUFXLGNBQVMsT0FBTzthQUEzQixXQUFXOzRCQUFYLFdBQVc7O1VBQVMsT0FBTztBQUFQLGVBQU87Ozs7Y0FBM0IsV0FBVyxFQUFTLE9BQU87O3lCQUEzQixXQUFXO0FBQ2YsWUFBTTtlQUFBLGtCQUFHO0FBQ1AsaUJBQU8sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUM7U0FDdkI7Ozs7QUFFRCxZQUFNO2VBQUEsa0JBQUc7QUFDUCxpQkFBTyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQztTQUN2Qjs7OztBQUVELFlBQU07ZUFBQSxrQkFBRztBQUNQLGlCQUFPO1NBQ1I7Ozs7QUFFSyxpQkFBVztlQUFBLHFCQUFDLFdBQVc7Ozs7b0RBQ3BCLFdBQVc7Ozs7OztTQUNuQjs7OztBQUVELG9CQUFjO2VBQUEsMEJBQUc7QUFDZixpQkFBTyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7U0FDaEQ7Ozs7OztXQW5CRyxXQUFXO0tBQVMsT0FBTzs7QUFzQmpDLFVBQVEsQ0FBQywrQkFBK0IsRUFBRSxZQUFNO0FBQzlDLE1BQUUsQ0FBQyxzREFBc0QsRUFBRSxZQUFNO0FBQy9ELFVBQUksT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7O0FBRWhDLFVBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQzs7QUFFdkMsWUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMs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LE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7QUFDaEUsYUFBTyxDQUFDLGFBQWEsR0FBRyxRQUFRLENBQUM7O0FBRWpDLGFBQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7O0FBRS9CLFlBQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsUUFBSyxDQUFDO0tBQ3BDLENBQUMsQ0FBQzs7QUFFSCxNQUFFLENBQUMsbUNBQW1DLEVBQUU7VUFDbEMsSUFBSSxFQUNKLE9BQU87Ozs7QUFEUCxnQkFBSSxHQUFHLElBQUksSUFBSSxFQUFFO0FBQ2pCLG1CQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDOzs7QUFFckQsa0JBQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDOzttQkFDakQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FDOUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDOzs7Ozs7S0FDdkMsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBRUosQ0FBQyxDQUFDIiwiZmlsZSI6InNyYy9fX3Rlc3RzX18vQWN0aW9ucy10ZXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmx1eCwgQWN0aW9ucyB9IGZyb20gJy4uL0ZsdXgnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcblxuZGVzY3JpYmUoJ0FjdGlvbnMnLCAoKSA9PiB7XG5cbiAgY2xhc3MgVGVzdEFjdGlvbnMgZXh0ZW5kcyBBY3Rpb25zIHtcbiAgICBnZXRGb28oKSB7XG4gICAgICByZXR1cm4geyBmb286ICdiYXInIH07XG4gICAgfVxuXG4gICAgZ2V0QmFyKCkge1xuICAgICAgcmV0dXJuIHsgYmFyOiAnYmF6JyB9O1xuICAgIH1cblxuICAgIGdldEJheigpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBhc3luYyBhc3luY0FjdGlvbihyZXR1cm5WYWx1ZSkge1xuICAgICAgcmV0dXJuIHJldHVyblZhbHVlO1xuICAgIH1cblxuICAgIGJhZEFzeW5jQWN0aW9uKCkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignc29tZSBlcnJvcicpKTtcbiAgICB9XG4gIH1cblxuICBkZXNjcmliZSgnI2dldEFjdGlvbklkcyAvICNnZXRDb25zdGFudHMnLCAoKSA9PiB7XG4gICAgaXQoJ3JldHVybnMgc3RyaW5ncyBjb3JyZXNwb25kaW5nIHRvIGFjdGlvbiBtZXRob2QgbmFtZXMnLCAoKSA9PiB7XG4gICAgICBsZXQgYWN0aW9ucyA9IG5ldyBUZXN0QWN0aW9ucygpO1xuXG4gICAgICBsZXQgYWN0aW9uSWRzID0gYWN0aW9ucy5nZXRBY3Rpb25JZHMoKTtcblxuICAgICAgZXhwZWN0KGFjdGlvbklkcy5nZXRGb28pLnRvLmJlLmEoJ3N0cmluZycpO1xuICAgICAgZXhwZWN0KGFjdGlvbklkcy5nZXRCYXIpLnRvLmJlLmEoJ3N0cmluZycpO1xuXG4gICAgICBleHBlY3QoYWN0aW9uSWRzLmdldEZvbykudG8uYmUuYSgnc3RyaW5nJyk7XG4gICAgICBleHBlY3QoYWN0aW9uSWRzLmdldEJhcikudG8uYmUuYSgnc3RyaW5nJyk7XG4gICAgfSk7XG5cbiAgfSk7XG5cbiAgZGVzY3JpYmUoJyNbbWV0aG9kTmFtZV0nLCAoKSA9PiB7XG4gICAgaXQoJ2NhbGxzIEZsdXggZGlzcGF0Y2hlcicsICgpID0+IHtcbiAgICAgIGxldCBhY3Rpb25zID0gbmV3IFRlc3RBY3Rpb25zKCk7XG5cbiAgICAgIC8vIEF0dGFjaCBtb2NrIGZsdXggaW5zdGFuY2VcbiAgICAgIGxldCBkaXNwYXRjaCA9IHNpbm9uLnNweSgpO1xuICAgICAgYWN0aW9ucy5kaXNwYXRjaCA9IGRpc3BhdGNoO1xuXG4gICAgICBhY3Rpb25zLmdldEZvbygpO1xuICAgICAgZXhwZWN0KGRpc3BhdGNoLmZpcnN0Q2FsbC5hcmdzWzFdKS50by5kZWVwLmVxdWFsKHsgZm9vOiAnYmFyJyB9KTtcbiAgICB9KTtcblxuICAgIGl0KCd3YXJucyBpZiBhY3Rpb25zIGhhdmUgbm90IGJlZW4gYWRkZWQgdG8gYSBGbHV4IGluc3RhbmNlJywgKCkgPT4ge1xuICAgICAgbGV0IGFjdGlvbnMgPSBuZXcgVGVzdEFjdGlvbnMoKTtcbiAgICAgIGxldCB3YXJuID0gc2lub24uc3B5KGNvbnNvbGUsICd3YXJuJyk7XG5cbiAgICAgIGFjdGlvbnMuZ2V0Rm9vKCk7XG5cbiAgICAgIGV4cGVjdCh3YXJuLmZpcnN0Q2FsbC5hcmdzWzBdKS50by5lcXVhbChcbiAgICAgICAgJ1lvdVxcJ3ZlIGF0dGVtcHRlZCB0byBwZXJmb3JtIHRoZSBhY3Rpb24gVGVzdEFjdGlvbnMjZ2V0Rm9vLCBidXQgaXQgJ1xuICAgICAgKyAnaGFzblxcJ3QgYmVlbiBhZGRlZCB0byBhIEZsdXggaW5zdGFuY2UuJ1xuICAgICAgKTtcblxuICAgICAgYWN0aW9ucy5hc3luY0FjdGlvbigpO1xuXG4gICAgICBleHBlY3Qod2Fybi5zZWNvbmRDYWxsLmFyZ3NbMF0pLnRvLmVxdWFsKFxuICAgICAgICBgWW91J3ZlIGF0dGVtcHRlZCB0byBwZXJmb3JtIHRoZSBhc3luY2hyb25vdXMgYWN0aW9uIGBcbiAgICAgICsgYFRlc3RBY3Rpb25zI2FzeW5jQWN0aW9uLCBidXQgaXQgaGFzbid0IGJlZW4gYWRkZWQgYFxuICAgICAgKyBgdG8gYSBGbHV4IGluc3RhbmNlLmBcbiAgICAgICk7XG5cbiAgICAgIGNvbnNvbGUud2Fybi5yZXN0b3JlKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2VuZHMgcmV0dXJuIHZhbHVlIHRvIEZsdXggZGlzcGF0Y2gnLCAoKSA9PiB7XG4gICAgICBsZXQgYWN0aW9ucyA9IG5ldyBUZXN0QWN0aW9ucygpO1xuICAgICAgbGV0IGFjdGlvbklkID0gYWN0aW9ucy5nZXRBY3Rpb25JZHMoKS5nZXRGb287XG4gICAgICBsZXQgZGlzcGF0Y2ggPSBzaW5vbi5zcHkoKTtcbiAgICAgIGFjdGlvbnMuZGlzcGF0Y2ggPSBkaXNwYXRjaDtcblxuICAgICAgYWN0aW9ucy5nZXRGb28oKTtcblxuICAgICAgZXhwZWN0KGRpc3BhdGNoLmZpcnN0Q2FsbC5hcmdzWzBdKS50by5lcXVhbChhY3Rpb25JZCk7XG4gICAgICBleHBlY3QoZGlzcGF0Y2guZmlyc3RDYWxsLmFyZ3NbMV0pLnRvLmRlZXAuZXF1YWwoeyBmb286ICdiYXInIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3NlbmQgYXN5bmMgcmV0dXJuIHZhbHVlIHRvIEZsdXgjZGlzcGF0Y2hBc3luYycsIGFzeW5jIGZ1bmN0aW9uKCkge1xuICAgICAgbGV0IGFjdGlvbnMgPSBuZXcgVGVzdEFjdGlvbnMoKTtcbiAgICAgIGxldCBhY3Rpb25JZCA9IGFjdGlvbnMuZ2V0QWN0aW9uSWRzKCkuYXN5bmNBY3Rpb247XG4gICAgICBsZXQgZGlzcGF0Y2ggPSBzaW5vbi5zdHViKCkucmV0dXJucyhQcm9taXNlLnJlc29sdmUoKSk7XG4gICAgICBhY3Rpb25zLmRpc3BhdGNoQXN5bmMgPSBkaXNwYXRjaDtcblxuICAgICAgbGV0IHJlc3BvbnNlID0gYWN0aW9ucy5hc3luY0FjdGlvbignZm9vYmFyJyk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS50aGVuKS50by5iZS5hKCdmdW5jdGlvbicpO1xuXG4gICAgICBhd2FpdCByZXNwb25zZTtcblxuICAgICAgZXhwZWN0KGRpc3BhdGNoLmZpcnN0Q2FsbC5hcmdzWzBdKS50by5lcXVhbChhY3Rpb25JZCk7XG4gICAgICBleHBlY3QoZGlzcGF0Y2guZmlyc3RDYWxsLmFyZ3NbMV0pLnRvLmJlLmFuLmluc3RhbmNlT2YoUHJvbWlzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2tpcHMgZGlzcHRhY2ggaWYgcmV0dXJuIHZhbHVlIGlzIHVuZGVmaW5lZCcsICgpID0+IHtcbiAgICAgIGxldCBhY3Rpb25zID0gbmV3IFRlc3RBY3Rpb25zKCk7XG4gICAgICBsZXQgZGlzcGF0Y2ggPSBzaW5vbi5zcHkoKTtcbiAgICAgIGFjdGlvbnMuZGlzcGF0Y2ggPSBkaXNwYXRjaDtcblxuICAgICAgYWN0aW9ucy5nZXRCYXooKTtcblxuICAgICAgZXhwZWN0KGRpc3BhdGNoLmNhbGxlZCkudG8uYmUuZmFsc2U7XG4gICAgfSk7XG5cbiAgICBpdCgnZG9lcyBub3Qgc2tpcCBhc3luYyBkaXNwYXRjaCwgZXZlbiBpZiByZXNvbHZlZCB2YWx1ZSBpcyB1bmRlZmluZWQnLCAoKSA9PiB7XG4gICAgICBsZXQgYWN0aW9ucyA9IG5ldyBUZXN0QWN0aW9ucygpO1xuICAgICAgbGV0IGRpc3BhdGNoID0gc2lub24uc3R1YigpLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCkpO1xuICAgICAgYWN0aW9ucy5kaXNwYXRjaEFzeW5jID0gZGlzcGF0Y2g7XG5cbiAgICAgIGFjdGlvbnMuYXN5bmNBY3Rpb24odW5kZWZpbmVkKTtcblxuICAgICAgZXhwZWN0KGRpc3BhdGNoLmNhbGxlZCkudG8uYmUudHJ1ZTtcbiAgICB9KTtcblxuICAgIGl0KCdyZXR1cm5zIHZhbHVlIGZyb20gd3JhcHBlZCBhY3Rpb24nLCBhc3luYyBmdW5jdGlvbigpIHtcbiAgICAgIGxldCBmbHV4ID0gbmV3IEZsdXgoKTtcbiAgICAgIGxldCBhY3Rpb25zID0gZmx1eC5jcmVhdGVBY3Rpb25zKCd0ZXN0JywgVGVzdEFjdGlvbnMpO1xuXG4gICAgICBleHBlY3QoYWN0aW9ucy5nZXRGb28oKSkudG8uZGVlcC5lcXVhbCh7IGZvbzogJ2JhcicgfSk7XG4gICAgICBhd2FpdCBleHBlY3QoYWN0aW9ucy5hc3luY0FjdGlvbignYXN5bmMgcmVzdWx0JykpXG4gICAgICAgIC50by5ldmVudHVhbGx5LmVxdWFsKCdhc3luYyByZXN1bHQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbn0pO1xuIl19